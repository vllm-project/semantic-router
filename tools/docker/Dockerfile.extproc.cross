# Cross-compilation optimized Dockerfile for multi-arch builds (amd64 + arm64)
# Runs on BUILDPLATFORM (amd64) and cross-compiles for TARGETARCH to avoid slow QEMU emulation.
ARG BUILDPLATFORM
FROM --platform=$BUILDPLATFORM rust:1.90 AS rust-cross-builder

# Install cross-compilation dependencies
RUN dpkg --add-architecture arm64 && \
    apt-get update && apt-get install -y \
    make \
    build-essential \
    pkg-config \
    lld \
    clang \
    binutils \
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    libc6-dev-arm64-cross \
    binutils-aarch64-linux-gnu \
    libssl-dev:arm64 \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Install cross-compilation Rust target
RUN rustup target add aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu

# Configure cross-compilation environment
ENV CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
ENV CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
ENV CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
ENV AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
ENV STRIP_aarch64_unknown_linux_gnu=aarch64-linux-gnu-strip
ENV OBJCOPY_aarch64_unknown_linux_gnu=aarch64-linux-gnu-objcopy

# Configure OpenSSL for cross-compilation
ENV PKG_CONFIG_ALLOW_CROSS=1
ENV PKG_CONFIG_PATH_aarch64_unknown_linux_gnu=/usr/lib/aarch64-linux-gnu/pkgconfig
ENV OPENSSL_DIR=/usr
ENV OPENSSL_INCLUDE_DIR=/usr/include/openssl

# Optimize Rust compilation
ENV CARGO_NET_GIT_FETCH_WITH_CLI=true
ENV CARGO_INCREMENTAL=1
ENV CARGO_PROFILE_RELEASE_LTO=thin
ENV CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1

ARG TARGETARCH

WORKDIR /app

# Copy dependency files first for better layer caching
COPY candle-binding/Cargo.toml ./candle-binding/
COPY candle-binding/Cargo.loc[k] ./candle-binding/
COPY tools/make/ tools/make/
COPY Makefile ./

# Pre-build dependencies to cache them (CPU-only, no CUDA)
# Uses a dummy lib.rs so only dependency crates are compiled and cached
RUN cd candle-binding && \
    mkdir -p src && \
    echo "pub fn _dummy() {}" > src/lib.rs && \
    if [ "$TARGETARCH" = "arm64" ]; then \
        OPENSSL_LIB_DIR=/usr/lib/aarch64-linux-gnu cargo build --release --no-default-features --target aarch64-unknown-linux-gnu; \
    else \
        OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu cargo build --release --no-default-features --target x86_64-unknown-linux-gnu; \
    fi && \
    rm -rf src

# Copy source code and build
COPY candle-binding/src/ ./candle-binding/src/

# Build with cross-compilation (reuses dependency cache from previous layer)
# IMPORTANT: Delete stale .so/.a from the dummy pre-build so cargo relinks with real FFI symbols
RUN echo "Building Rust library (CPU-only, no CUDA) for TARGETARCH=$TARGETARCH..." && \
    cd candle-binding && \
    find target -name "libcandle_semantic_router.so" -delete 2>/dev/null; \
    find target -name "libcandle_semantic_router.a" -delete 2>/dev/null; \
    if [ "$TARGETARCH" = "arm64" ]; then \
        OPENSSL_LIB_DIR=/usr/lib/aarch64-linux-gnu cargo build --release --no-default-features --target aarch64-unknown-linux-gnu; \
    else \
        OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu cargo build --release --no-default-features --target x86_64-unknown-linux-gnu; \
    fi && \
    echo "=== Verifying library ===" && \
    find target -name "libcandle_semantic_router.so" -type f -exec ls -la {} \; && \
    find target -name "libcandle_semantic_router.so" -type f -exec sh -c 'nm -D "$1" | grep -c "T "' _ {} \;

# Build the Go application
ARG BUILDPLATFORM
FROM --platform=$BUILDPLATFORM golang:1.24 AS go-builder

# Install cross-compilation tools for Go
RUN dpkg --add-architecture arm64 && \
    apt-get update && apt-get install -y \
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    libssl-dev:arm64 \
    libssl-dev \
    file \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy Go module files first for better layer caching
RUN mkdir -p src/semantic-router
COPY src/semantic-router/go.mod src/semantic-router/go.sum src/semantic-router/
COPY candle-binding/go.mod candle-binding/semantic-router.go candle-binding/

# Download Go dependencies (cached layer)
RUN cd src/semantic-router && go mod download && \
    cd /app/candle-binding && go mod download

# Copy semantic-router source code
COPY src/semantic-router/ src/semantic-router/

# Copy the built Rust library from rust-cross-builder
ARG TARGETARCH

# Copy the entire target directory, then extract the correct platform library
COPY --from=rust-cross-builder /app/candle-binding/target/ /tmp/rust-target/
RUN mkdir -p /app/candle-binding/target/release && \
    if [ "$TARGETARCH" = "arm64" ]; then \
        cp /tmp/rust-target/aarch64-unknown-linux-gnu/release/libcandle_semantic_router.so /app/candle-binding/target/release/ && \
        (cp /tmp/rust-target/aarch64-unknown-linux-gnu/release/libcandle_semantic_router.a /app/candle-binding/target/release/ 2>/dev/null || true); \
    else \
        cp /tmp/rust-target/x86_64-unknown-linux-gnu/release/libcandle_semantic_router.so /app/candle-binding/target/release/ && \
        (cp /tmp/rust-target/x86_64-unknown-linux-gnu/release/libcandle_semantic_router.a /app/candle-binding/target/release/ 2>/dev/null || true); \
    fi && \
    rm -rf /tmp/rust-target

# Set environment variables for CGO to find the libraries
ENV CGO_ENABLED=1
ENV LD_LIBRARY_PATH=/app/candle-binding/target/release
ENV GOOS=linux

# Verify the library exists and has expected symbols
RUN echo "Verifying Rust library for TARGETARCH=$TARGETARCH..." && \
    ls -la /app/candle-binding/target/release/libcandle_semantic_router.* && \
    file /app/candle-binding/target/release/libcandle_semantic_router.so

# Build the router binary with cross-compilation support
RUN mkdir -p bin && cd src/semantic-router && \
    if [ "$TARGETARCH" = "arm64" ]; then \
        echo "Building for ARM64 with cross-compilation..." && \
        CC=aarch64-linux-gnu-gcc \
        CXX=aarch64-linux-gnu-g++ \
        PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig \
        CGO_CFLAGS="-I/app/candle-binding" \
        CGO_LDFLAGS="-L/app/candle-binding/target/release -L/usr/lib/aarch64-linux-gnu -lcandle_semantic_router -lssl -lcrypto" \
        GOOS=linux GOARCH=arm64 \
        go build -ldflags="-w -s" -o ../../bin/router cmd/main.go; \
    else \
        echo "Building for AMD64..." && \
        CGO_CFLAGS="-I/app/candle-binding" \
        CGO_LDFLAGS="-L/app/candle-binding/target/release -lcandle_semantic_router" \
        go build -ldflags="-w -s" -o ../../bin/router cmd/main.go; \
    fi

# Final stage: copy the binary and the shared library
FROM quay.io/centos/centos:stream10

# Install runtime dependencies including OpenSSL, Python and HuggingFace CLI
RUN dnf update -y && \
    dnf install -y \
    openssl-libs \
    python3 \
    python3-pip \
    ca-certificates && \
    dnf clean all && \
    pip3 install --no-cache-dir huggingface_hub[cli]

WORKDIR /app

COPY --from=go-builder /app/bin/router /app/extproc-server
COPY --from=go-builder /app/candle-binding/target/release/libcandle_semantic_router.so /app/lib/
COPY config/config.yaml /app/config/

ENV LD_LIBRARY_PATH=/app/lib

EXPOSE 50051

# Copy entrypoint to allow switching config via env var CONFIG_FILE
COPY scripts/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

ENTRYPOINT ["/app/entrypoint.sh"]
