# Build the Rust library (single-platform, used for PR amd64-only builds)
FROM rust:1.90 AS rust-builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    make \
    build-essential \
    pkg-config \
    lld \
    clang \
    binutils \
    && rm -rf /var/lib/apt/lists/*

# Configure Cargo for optimized builds
ENV CARGO_NET_GIT_FETCH_WITH_CLI=true
ENV CARGO_INCREMENTAL=1
ENV CARGO_PROFILE_RELEASE_LTO=thin
ENV CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
ENV RUSTFLAGS="-C link-arg=-fuse-ld=lld"

WORKDIR /app

# Copy dependency files first for better layer caching
COPY candle-binding/Cargo.toml ./candle-binding/
# Copy Cargo.lock if it exists in the build context
COPY candle-binding/Cargo.loc[k] ./candle-binding/
COPY tools/make/ tools/make/
COPY Makefile ./

# Pre-build dependencies to cache them (CPU-only, no CUDA)
# Uses a dummy lib.rs so only dependency crates are compiled and cached
RUN cd candle-binding && \
    mkdir -p src && \
    echo "pub fn _dummy() {}" > src/lib.rs && \
    cargo build --release --no-default-features && \
    rm -rf src

# Copy source code and build
COPY candle-binding/src/ ./candle-binding/src/

# Build Rust library with actual source (reuses dependency cache from previous layer)
# IMPORTANT: Delete stale .so/.a from the dummy pre-build so cargo is forced to
# relink the cdylib/staticlib with real FFI symbols.
RUN echo "Building Rust library (CPU-only, no CUDA)..." && \
    cd candle-binding && \
    find target -name "libcandle_semantic_router.so" -delete 2>/dev/null; \
    find target -name "libcandle_semantic_router.a" -delete 2>/dev/null; \
    cargo build --release --no-default-features && \
    echo "=== Verifying library symbols ===" && \
    ls -la target/release/libcandle_semantic_router.so && \
    nm -D target/release/libcandle_semantic_router.so | grep -c "T " && \
    echo "Sample exported symbols:" && \
    nm -D target/release/libcandle_semantic_router.so | grep " T " | head -10

# Build the Go application
FROM golang:1.24 AS go-builder

WORKDIR /app

# Copy Go module files first for better layer caching
RUN mkdir -p src/semantic-router
COPY src/semantic-router/go.mod src/semantic-router/go.sum src/semantic-router/
COPY candle-binding/go.mod candle-binding/semantic-router.go candle-binding/

# Pre-download modules to fail fast if mirrors are unreachable
RUN cd src/semantic-router && go mod download && \
    cd /app/candle-binding && go mod download

# Copy semantic-router source code
COPY src/semantic-router/ src/semantic-router/

# Copy the built Rust library from rust-builder (both .so and .a for linking)
COPY --from=rust-builder /app/candle-binding/target/release/libcandle_semantic_router.so /app/candle-binding/target/release/
COPY --from=rust-builder /app/candle-binding/target/release/libcandle_semantic_router.a /app/candle-binding/target/release/

# Set environment variables for CGO to find the libraries
ENV CGO_ENABLED=1
ENV LD_LIBRARY_PATH=/app/candle-binding/target/release
ENV GOOS=linux

# Verify the library exists and has expected symbols before Go build
RUN echo "Verifying Rust library before Go build..." && \
    ls -la /app/candle-binding/target/release/libcandle_semantic_router.* && \
    file /app/candle-binding/target/release/libcandle_semantic_router.so

# Build the router binary with optimizations
RUN mkdir -p bin && cd src/semantic-router && \
    go build -ldflags="-w -s" -o ../../bin/router cmd/main.go

# Final stage: copy the binary and the shared library
FROM quay.io/centos/centos:stream10

# Install runtime dependencies including Python and HuggingFace CLI
RUN dnf -y update && \
    dnf -y install \
    python3 \
    python3-pip \
    ca-certificates && \
    dnf clean all && \
    pip3 install --no-cache-dir huggingface_hub[cli]

WORKDIR /app

COPY --from=go-builder /app/bin/router /app/extproc-server
COPY --from=go-builder /app/candle-binding/target/release/libcandle_semantic_router.so /app/lib/
COPY config/config.yaml /app/config/

ENV LD_LIBRARY_PATH=/app/lib

EXPOSE 50051

# Copy entrypoint to allow switching config via env var CONFIG_FILE
COPY scripts/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

ENTRYPOINT ["/app/entrypoint.sh"]
