# Standalone Envoy config with JWT authentication (no Kubernetes required)
#
# Single Envoy does everything:
#   1. jwt_authn filter — validates JWT RSA256 signature, checks issuer/audience,
#      extracts claims to headers (sub → x-jwt-sub, groups → x-jwt-groups)
#   2. ext_proc filter — calls semantic router for RBAC + model selection
#   3. ORIGINAL_DST cluster — routes to the correct vLLM backend dynamically
#
# Flow:
#   Client (Authorization: Bearer <JWT>)
#     → Envoy :8802
#       → jwt_authn (validate + extract claims)
#       → ext_proc (semantic router :50053, reads x-jwt-sub/x-jwt-groups)
#       → ORIGINAL_DST (routes via x-vsr-destination-endpoint to vLLM)
#
# Prerequisites:
#   - JWKS file at /etc/envoy/jwks.json (mounted by setup.sh)
#   - Semantic router on 127.0.0.1:50053 with EG identity config
#   - vLLM 14B on 127.0.0.1:8000, 7B on 127.0.0.1:8001
#
# Listener: 0.0.0.0:8802
# Admin:    127.0.0.1:19002

static_resources:
  listeners:
  - name: jwt_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8802
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: jwt_ingress
          access_log:
          - name: envoy.access_loggers.stdout
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
              log_format:
                json_format:
                  time: "%START_TIME%"
                  method: "%REQ(:METHOD)%"
                  path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                  status: "%RESPONSE_CODE%"
                  upstream: "%UPSTREAM_HOST%"
                  model: "%REQ(X-SELECTED-MODEL)%"
                  jwt_sub: "%REQ(x-jwt-sub)%"
                  jwt_groups: "%REQ(x-jwt-groups)%"
          route_config:
            name: jwt_route
            virtual_hosts:
            - name: llm_service
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: vllm_dynamic_cluster
                  timeout: 300s
          http_filters:
          # ── Filter 1: JWT Authentication ──
          # Validates RSA256 signature against local JWKS, checks issuer/audience,
          # extracts claims to request headers for the semantic router.
          - name: envoy.filters.http.jwt_authn
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
              providers:
                jwt_provider:
                  issuer: "https://eg-jwt-issuer.example.com"
                  audiences:
                    - "semantic-router"
                  local_jwks:
                    filename: "/etc/envoy/jwks.json"
                  forward: true
                  claim_to_headers:
                    - header_name: x-jwt-sub
                      claim_name: sub
                    - header_name: x-jwt-groups
                      claim_name: groups
              rules:
                # /health — no JWT required (health checks)
                - match:
                    prefix: /health
                # All other paths — require valid JWT
                - match:
                    prefix: /
                  requires:
                    provider_name: jwt_provider
          # ── Filter 2: ext_proc (Semantic Router) ──
          # Reads x-jwt-sub / x-jwt-groups headers, evaluates RBAC role bindings,
          # selects model, sets x-vsr-destination-endpoint for dynamic routing.
          - name: envoy.filters.http.ext_proc
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
              grpc_service:
                envoy_grpc:
                  cluster_name: extproc_service
              allow_mode_override: true
              processing_mode:
                request_header_mode: "SEND"
                response_header_mode: "SEND"
                request_body_mode: "BUFFERED"
                response_body_mode: "BUFFERED"
                request_trailer_mode: "SKIP"
                response_trailer_mode: "SKIP"
              failure_mode_allow: true
              message_timeout: 300s
          # ── Filter 3: Router ──
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              suppress_envoy_headers: true
          http2_protocol_options:
            max_concurrent_streams: 100
            initial_stream_window_size: 65536
            initial_connection_window_size: 1048576
          stream_idle_timeout: "300s"
          request_timeout: "300s"
          common_http_protocol_options:
            idle_timeout: "300s"

  clusters:
  # Semantic Router ext_proc gRPC service
  - name: extproc_service
    connect_timeout: 300s
    per_connection_buffer_limit_bytes: 52428800
    type: STATIC
    lb_policy: ROUND_ROBIN
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options:
            connection_keepalive:
              interval: 300s
              timeout: 300s
    load_assignment:
      cluster_name: extproc_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 50053

  # Dynamic vLLM cluster — routes based on x-vsr-destination-endpoint header
  - name: vllm_dynamic_cluster
    connect_timeout: 300s
    per_connection_buffer_limit_bytes: 52428800
    type: ORIGINAL_DST
    lb_policy: CLUSTER_PROVIDED
    original_dst_lb_config:
      use_http_header: true
      http_header_name: "x-vsr-destination-endpoint"
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http_protocol_options: {}

admin:
  address:
    socket_address:
      address: "127.0.0.1"
      port_value: 19002
