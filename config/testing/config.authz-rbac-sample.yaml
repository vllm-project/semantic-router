# Live RBAC Test Config — Two local Qwen vLLM endpoints
#
# Prerequisites:
#   - Qwen/Qwen2.5-14B-Instruct on localhost:8000
#   - Qwen/Qwen2.5-7B-Instruct  on localhost:8001
#   - Authorino or mock injecting x-authz-user-id / x-authz-user-groups headers
#
# RBAC tiers:
#   admin       → 14B (unrestricted, reasoning enabled)
#   premium_tier → 14B (complex queries) or 7B (simple / realtime)
#   pro_tier     → 7B (all queries)
#   free_tier    → 7B (short queries only, long queries rejected by no matching decision)
#
# Test matrix (send requests with different x-authz-user-id / x-authz-user-groups):
#
#   User: alice   Groups: engineering        → pro_tier   → Qwen2.5-7B
#   User: bob     Groups: premium            → premium    → Qwen2.5-14B or 7B
#   User: admin   Groups: (none)             → admin      → Qwen2.5-14B + reasoning
#   User: dave    Groups: free               → free_tier  → Qwen2.5-7B
#   User: eve     Groups: contractor         → free_tier  → Qwen2.5-7B
#   User: unknown Groups: (none)             → no match   → (depends on default_model)
#

# --------------------------------------------------------------------------
# Authz — local vLLM backends don't require API keys
# --------------------------------------------------------------------------
authz:
  fail_open: true

# --------------------------------------------------------------------------
# vLLM Endpoints — the two real running backends
# --------------------------------------------------------------------------
vllm_endpoints:
  - name: "qwen-14b"
    address: "127.0.0.1"
    port: 8000
    weight: 1
    health_check_path: "/health"
  - name: "qwen-7b"
    address: "127.0.0.1"
    port: 8001
    weight: 1
    health_check_path: "/health"

# --------------------------------------------------------------------------
# Model Config — maps model names to endpoints
# --------------------------------------------------------------------------
model_config:
  "Qwen/Qwen2.5-14B-Instruct":
    model_name: "Qwen/Qwen2.5-14B-Instruct"
    access_key: ""
    quality_score: 0.90
    preferred_endpoints: ["qwen-14b"]

  "Qwen/Qwen2.5-7B-Instruct":
    model_name: "Qwen/Qwen2.5-7B-Instruct"
    access_key: ""
    quality_score: 0.70
    preferred_endpoints: ["qwen-7b"]

# --------------------------------------------------------------------------
# Default model — used when no decision matches
# --------------------------------------------------------------------------
default_model: "Qwen/Qwen2.5-7B-Instruct"

# --------------------------------------------------------------------------
# Keyword Rules — content signals for complex vs simple routing
# --------------------------------------------------------------------------
keyword_rules:
  - name: "complex_analysis"
    operator: "OR"
    keywords: ["analyze", "reasoning", "think step by step", "explain why", "compare", "evaluate"]

  - name: "code_request"
    operator: "OR"
    keywords: ["write code", "implement", "function", "algorithm", "debug", "refactor"]

# --------------------------------------------------------------------------
# Context Rules — token count signals
# --------------------------------------------------------------------------
context_rules:
  - name: "short_query"
    min_tokens: "0"
    max_tokens: "500"
    description: "Short queries under 500 tokens"

  - name: "long_document"
    min_tokens: "4K"
    max_tokens: "32K"
    description: "Long documents 4K-32K tokens"

# --------------------------------------------------------------------------
# Role Bindings — RBAC subject-to-role assignment
# --------------------------------------------------------------------------
# Subject names MUST match the x-authz-user-id and x-authz-user-groups
# header values injected by Authorino or the test harness.
# --------------------------------------------------------------------------
role_bindings:
  # admin user (Secret: user-admin, metadata.name="user-admin", authz-groups="")
  - name: "admin-users"
    description: "Admin users — full access to all models"
    subjects:
      - kind: User
        name: "user-admin"
    role: "admin"

  # bob (Secret: user-bob-shared, authz-groups="premium")
  - name: "premium-customers"
    description: "Premium customers"
    subjects:
      - kind: Group
        name: "premium"
    role: "premium_tier"

  # alice (Secret: user-alice-per-user, authz-groups="engineering")
  - name: "pro-internal"
    description: "Internal engineering teams"
    subjects:
      - kind: Group
        name: "engineering"
    role: "pro_tier"

  # carol (Secret: user-carol-shared, authz-groups="free")
  # dave (Secret: user-dave-byot, authz-groups="contractor")
  - name: "free-external"
    description: "Free tier — free users, contractors"
    subjects:
      - kind: Group
        name: "free"
      - kind: Group
        name: "contractor"
    role: "free_tier"

# --------------------------------------------------------------------------
# Decisions — RBAC permissions (what each role can access)
# --------------------------------------------------------------------------
# Priority determines evaluation order (higher = checked first).
# Cost is implicit: 14B is the expensive model, 7B is the cheap one.
# --------------------------------------------------------------------------
decisions:
  # ── Admin: unrestricted, reasoning enabled ──
  - name: "admin_unrestricted"
    description: "Admin users get 14B with reasoning"
    priority: 300
    rules:
      operator: "AND"
      conditions:
        - type: "authz"
          name: "admin"
    modelRefs:
      - model: "Qwen/Qwen2.5-14B-Instruct"
        use_reasoning: true
      - model: "Qwen/Qwen2.5-7B-Instruct"
        use_reasoning: false

  # ── Premium + complex query → 14B with reasoning ──
  - name: "premium_complex"
    description: "Premium users with complex queries get 14B + reasoning"
    priority: 250
    rules:
      operator: "AND"
      conditions:
        - type: "authz"
          name: "premium_tier"
        - type: "keyword"
          name: "complex_analysis"
    modelRefs:
      - model: "Qwen/Qwen2.5-14B-Instruct"
        use_reasoning: true

  # ── Premium + code request → 14B ──
  - name: "premium_code"
    description: "Premium users with code requests get 14B"
    priority: 240
    rules:
      operator: "AND"
      conditions:
        - type: "authz"
          name: "premium_tier"
        - type: "keyword"
          name: "code_request"
    modelRefs:
      - model: "Qwen/Qwen2.5-14B-Instruct"
        use_reasoning: false

  # ── Premium default → 7B for simple queries (cost savings) ──
  - name: "premium_default"
    description: "Premium users simple queries get 7B (cost-efficient)"
    priority: 150
    rules:
      operator: "AND"
      conditions:
        - type: "authz"
          name: "premium_tier"
    modelRefs:
      - model: "Qwen/Qwen2.5-7B-Instruct"
        use_reasoning: false

  # ── Pro tier → always 7B ──
  - name: "pro_default"
    description: "Pro users always get 7B"
    priority: 120
    rules:
      operator: "AND"
      conditions:
        - type: "authz"
          name: "pro_tier"
    modelRefs:
      - model: "Qwen/Qwen2.5-7B-Instruct"
        use_reasoning: false

  # ── Free tier + short query → 7B ──
  - name: "free_short"
    description: "Free users with short queries get 7B"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "authz"
          name: "free_tier"
        - type: "context"
          name: "short_query"
    modelRefs:
      - model: "Qwen/Qwen2.5-7B-Instruct"
        use_reasoning: false

  # ── Free tier default → 7B (fallback for medium-length queries) ──
  - name: "free_default"
    description: "Free users default route"
    priority: 90
    rules:
      operator: "AND"
      conditions:
        - type: "authz"
          name: "free_tier"
    modelRefs:
      - model: "Qwen/Qwen2.5-7B-Instruct"
        use_reasoning: false
